<html>
<body>
	<span style="display: none" data-provider="currentDocument" onchange="_viewDocument.refresh()"></span>
	<span style="display: none" data-provider="currentItem" onchange="_viewDocument.refreshLinkToItem()"></span>
	<form id="viewDocumentForm">
		<fieldset class="form-group border-bottom">
			<div class="bd-callout-info bd-callout">
				<div class="form-group row">
					<label class="col-sm-2 col-form-label col-form-label-sm" for="view_document_form_name" data-i18n="form.document.name"></label>
					<div class="col-10">
						<input class="form-control form-control-sm" id="view_document_form_name" onkeypress="_viewDocument.onNameChange()"/>
					</div>
				</div>
				<div class="form-group row">
					<label class="col-sm-2 col-form-label col-form-label-sm" for="view_document_form_type" data-i18n="form.document.type"></label>
					<div class="col-10">
						<input class="form-control form-control-sm" id="view_document_form_type" onChange=""  readonly="true"/>
					</div>
				</div>
				<div class="form-group row">
					<label class="col-sm-2 col-form-label col-form-label-sm" for="view_document_form_item" data-i18n="form.item.name" readonly="true"></label>
					<div class="col-8">
						<a href="#" id="view_document_form_item" onClick="global.item.open(_viewDocument._itemId)"/>
						<button id="viewDocumentLink" onClick="_viewDocument.linkToCurrentItem()" type="button" class="btn btn-primary btn-sm" style="display:none">
							<!--span data-i18n="form.button.link" /-->Link to current item
						</button>
					</div>
					<div class="col-2">
						<button id="viewDocumentUnlink" onClick="_viewDocument.unlinkFromItem()" type="button" class="btn btn-danger btn-sm" style="width:100%;display:none">
							<!--span data-i18n="form.button.link" /-->Unlink
						</button>
					</div>
				</div>
				<div class="form-group row">
					<div class="col-sm-10">
						<button id="viewDocumentUpdate" onClick="_viewDocument.update()" type="button" class="btn btn-primary btn-sm">
							<img src='images/93.png' /> <span data-i18n="form.button.validate" />
						</button>
					</div>
				</div>
			</div>
		</fieldset>
	</form>
	<textarea style="width:100%" id="view_document_content" onkeypress="_viewDocument.onContentChange()"></textarea>
	<script type="text/javascript">
		var _viewDocument = {
			_contentChanged : false,
			_itemId	: null,
			onNameChange : function(){
				$("#viewDocumentUpdate").prop("disabled",false);
			},
			onContentChange : function(){
				this._contentChanged = true;
				$("#viewDocumentUpdate").prop("disabled",false);
			},
			update : function(){
				var document = global.document.getCurrent();
				if (document == null) {
					sendMessage("error","No current document");
					return;
				}
				var data = new Object();
				data.id = document.id;
				data.name = $("#view_document_form_name").val();
				data.type = $("#view_document_form_type").val();
				if (this._contentChanged){
					data.content = $("#view_document_content").val();
				}
				$.ajax({
					"url" : "api/document.php",
					"method" : "POST",
					"data" : data,
					"dataType" : "json",
					"success" : function(data) {
						sendMessage("success", i18next.t("message.document_success_update"));
						global.document.refresh();
					}
				}).fail(function(jxqr, textStatus, error) {
					sendMessage("error", i18next.t("message.document_failure_update") + " : " + error);
				});
			},
			refresh : function() {
				$("#view_document_form_name").val("");
				$("#view_document_form_type").val("");
				$("#view_document_content").val("");
				$("#viewDocumentUpdate").prop("disabled",true);
				var document = global.document.getCurrent();
				if (document != null) {
					$.ajax({
						url : "api/document.php?id=" + document.id + "&content=true",
						dataType : "text",
						success : function(data) {
							$("#view_document_content").val(data);
						}
					}).fail(function(jxqr, textStatus, error) {
						sendMessage("error", i18next.t("message.document_failure_get") + " : " + error);
					});
					$.ajax({
						url : "api/document.php?id=" + document.id,
						dataType : "json",
						success : function(result) {
							if (result.documents.length == 0){
								sendMessage("error", i18next.t("message.document_failure_get") + " : " + error);
							} else {
								var document = result.documents[0];
								$("#view_document_form_name").val(document.name);
								$("#view_document_form_type").val(document.type);
							}
						}
					}).fail(function(jxqr, textStatus, error) {
						sendMessage("error", i18next.t("message.document_failure_get") + " : " + error);
					});
					this.refreshLinkToItem();
				}
			},
			refreshLinkToItem : function(){
				this._itemId = null;
				var document = global.document.getCurrent();
				if (document != null) {
					$.ajax({
						url : "api/item.php?documentId=" + document.id,
						dataType : "json",
						success : function(result) {
							if (result.code != 0){
								sendMessage("error", i18next.t("message.document_failure_get") + " : " + error);
							} else if (result.objects.length > 0){
								_viewDocument._itemId = result.objects[0].id;
								$("#view_document_form_item").show();
								$("#view_document_form_item").text(result.objects[0].category.name + " " + result.objects[0].name);
								$("#viewDocumentLink").hide();
								$("#viewDocumentUnlink").show();
							} else {
								$("#viewDocumentUnlink").hide();
								if (global.item.getCurrent() != null){
									$("#view_document_form_item").hide();
									$("#viewDocumentLink").show();
								} else {
									$("#viewDocumentLink").hide();
									$("#view_document_form_item").text("");
									$("#view_document_form_item").show();
								}
							}
						}
					}).fail(function(jxqr, textStatus, error) {
						sendMessage("error", i18next.t("message.document_failure_get") + " : " + error);
					});
				} else {
					$("#viewDocumentUnlink").hide();
					$("#viewDocumentLink").hide();
					$("#view_document_form_item").text("");
					$("#view_document_form_item").show();
				}
			},
			linkToCurrentItem : function(){
				var document = global.document.getCurrent();
				var item = global.item.getCurrent();
				if (item == null){
					sendMessage("warning","No current item");
					return;
				}
				if (document == null){
					sendMessage("warning","No current document");
					return;
				}
				var data = new Object();
				data.id = document.id;
				data.itemId = item.id;
				$.ajax({
					"url" 		: "api/document.php",
					"method" 	: "POST",
					"data" 		: data,
					"dataType" 	: "json",
					"success" 	: function(result) {
						if (result.code != 0){
							sendMessage("error", i18next.t("message.document_failure_update") + " : " + result.message);
						} else {
							sendMessage("success", i18next.t("message.document_success_update"));
							global.document.refresh();
							global.item.refresh();
						}
					}
				}).fail(function(jxqr, textStatus, error) {
					sendMessage("error", i18next.t("message.document_failure_update") + " : " + error);
				});
			},
			unlinkFromItem : function(){
				var document = global.document.getCurrent();
				if (document == null){
					sendMessage("warning","No current document");
					return;
				}
				if (this._itemId == null){
					sendMessage("warning","No linked item");
					return;
				}
				global.document.unlinkFromItem(document.id,this._itemId);
			}
		};
		$(function() {
			$("#viewDocumentForm").find('*[data-i18n]').localize();
			_viewDocument.refresh();
		});
	</script>
</body>
</html>