<html>
<body>
	<form id="viewItemForm">
		<span style="display: none" data-provider="currentItem" onchange="_viewItem.refreshItem(global.item.getCurrent())"></span>
		<ul class="nav nav-pills mb-3" id="myTab" role="tablist">
			<li class="nav-item"><a class="nav-link active" id="detail-tab" data-toggle="tab"
				href="#detail" role="tab" aria-controls="detail" aria-selected="true" data-i18n="form.item.detail"></a></li>
			<li class="nav-item"><a class="nav-link" id="description-tab" data-toggle="tab"
				href="#description" role="tab" aria-controls="description" aria-selected="false" data-i18n="form.item.description"></a>
			</li>
			<li class="nav-item"><a class="nav-link" id="documents-tab" data-toggle="tab"
				href="#documents" role="tab" aria-controls="documents" aria-selected="false" data-i18n="form.item.documents"></a>
			</li>
			<li class="nav-item"><a class="nav-link" id="relateds-tab" data-toggle="tab"
				href="#relateds" role="tab" aria-controls="relateds" aria-selected="false" data-i18n="form.item.relateds"></a>
			</li>
			<li class="nav-item"><a class="nav-link" id="viewItemFilters-tab" data-toggle="tab"
				href="#viewItemFilters" role="tab" aria-controls="viewItemFilters" aria-selected="false" data-i18n="form.item.filters"></a>
			</li>
		</ul>
		<div class="tab-content" id="myTabContent">
			<div class="tab-pane fade show active" id="detail" role="tabpanel"
				aria-labelledby="detail-tab">
				<div class="bd-callout-info bd-callout">
					<fieldset class="form-group">
						<legend data-i18n="form.item.fields"></legend>
						<div class="form-group row">
							<label class="col-sm-2 col-form-label col-form-label-sm" for="viewItemId" data-i18n="form.item.id"></label>
							<div class="col-10">
								<input class="form-control form-control-sm" type="text" id="viewItemId" readonly="true"/>
							</div>
						</div>
						<div class="form-group row">
							<label class="col-sm-2 col-form-label col-form-label-sm" for="viewItemName" data-i18n="form.item.name"></label>
							<div class="col-10">
								<input class="form-control form-control-sm" type="text" id="viewItemName" />
							</div>
						</div>
						<div class="form-group row">
							<label class="col-sm-2 col-form-label col-form-label-sm" for="viewItemCategory" data-i18n="form.item.category"></label>
							<div class="col-10">
								<input class="form-control form-control-sm" type="text" id="viewItemCategory" readonly="true"/>
							</div>
						</div>
						<div class="form-group row">
							<label class="col-sm-2 col-form-label col-form-label-sm" for="viewItemClass" data-i18n="form.item.class"></label>
							<div class="col-10">
								<input class="form-control form-control-sm" type="text" id="viewItemClass" readonly="true"/>
							</div>
						</div>
						<div class="table-responsive">
							<table class="table table-bordered table-hover table-sm">
								<thead>
									<tr>
										<th>Key</th>
										<th>Value</th>
									</tr>
								</thead>
								<tbody id="viewItemProperties"></tbody>
							</table>
						</div>
					</fieldset>
					<hr />
					<button class="btn btn-primary btn-sm" type="button" onclick='_viewItem.updateItem();'
						id="viewItemUpdateButton">
						<img src='images/92.png' /> <span data-i18n="form.button.update"></span>
					</button>
					<button class="btn btn-danger btn-sm" type="button"
						onclick='global.item.delete(global.item.getCurrent().id);' id="viewItemDeleteButton">
						<img src='images/14.png' /> <span data-i18n="form.button.delete"></span>
					</button>
				</div>
			</div>
			<div class="tab-pane fade" id="description" role="tabpanel"
				aria-labelledby="description-tab">
				<div class="bd-callout-info bd-callout">
					<fieldset class="form-group">
					<legend data-i18n="form.item.description"></legend>
						<div class="form-group row">
							<!--label class="col-sm-2 col-form-label col-form-label-sm" for="viewItemDescription">Description</label-->
							<textarea id="viewItemDescription" class="form-control form-control-sm"
								style="margin: 15px" rows="" cols="">
							</textarea>
						</div>
					</fieldset>
				</div>
			</div>
			<div class="tab-pane fade" id="relateds" role="tabpanel" aria-labelledby="relateds-tab">
				<fieldset class="form-group">
					<legend data-i18n="form.item.relateds"></legend>
					<table class="table table-bordered table-hover table-sm">
						<thead>
							<tr>
								<th style="width:50px;text-align:center" data-i18n="form.item.link"></th>
								<th style="width:10%;text-align:center" data-i18n="form.item.category"></th>
								<th style="text-align:center" data-i18n="form.item.name"></th>
								<th style="width:10%;text-align:center" data-i18n="form.all.action"></th>
							</tr>
						</thead>
						<tbody id="viewItemRelatedItems"></tbody>
					</table>
				</fieldset>
			</div>
			<div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
				<fieldset class="form-group">
					<legend data-i18n="form.item.documents"></legend>
						<table class="table table-bordered table-hover table-sm">
							<thead>
								<tr>
									<th data-i18n="form.document.name"></th>
									<th data-i18n="form.document.type"></th>
									<th data-i18n="form.all.action"></th>
								</tr>
							</thead>
							<tbody id="viewItemDocumentsList"></tbody>
						</table>
				</fieldset>
			</div>
			<div class="tab-pane fade" id="viewItemFilters" role="tabpanel"
				aria-labelledby="viewItemFilters-tab">
				<div class="bd-callout-info bd-callout">
				<fieldset class="form-group">
					<legend data-i18n="form.item.filters"></legend>
					<span data-i18n="form.item.filter_direction"></span> :<br/>
					<div style="margin-left : 25px;margin-top:10px;margin-bottom:10px">
						<button class='btn btn-sm btn-primary' id="viewItemUpFilter" onclick="_viewItem.toggleFilter('up');  " title="Display up related items"><img src="images/55.png"/> <span data-i18n="form.item.up"></span></button>
						<button class='btn btn-sm btn-primary' id="viewItemDownFilter" onclick="_viewItem.toggleFilter('down');" title="Display down related items"><img src="images/54.png"/> <span data-i18n="form.item.down"></span></button>
					</div>
					<span data-i18n="form.item.filter_categories"></span> :<br/>
					<div id="viewItemFilterCategories" style="margin-left : 25px;margin-top:10px;margin-bottom:10px"></div>
					<button class='btn btn-sm btn-primary' onclick="_viewItem.resetFilter();_viewItem.updateCategoryFilter();_viewItem.refreshRelateds(global.item.getCurrent());" data-i18n="form.item.show_all"></button>
				</fieldset>
				</div>
			</div>
		</div>
	</form>
	<script>
	var _viewItem = {
		_categoryFilter : null,
		_directionUp : true,
		_directionDown : true,
		resetFilter : function(){
			var categories = global.itemCategories;
			for (var c = 0; c < categories.length; c++){
				this._categoryFilter[categories[c].id] = true;
			}
		},
		toggleFilter : function(direction){
			if (direction == 'up'){
				this._directionUp = !this._directionUp;
				if (this._directionUp){
					$("#viewItemUpFilter").addClass("btn-primary");
					$("#viewItemUpFilter").removeClass("btn-secondary");
				} else {
					$("#viewItemUpFilter").removeClass("btn-primary");
					$("#viewItemUpFilter").addClass("btn-secondary");
				}
			} else if (direction == 'down'){
				this._directionDown = !this._directionDown;
				if (this._directionDown){
					$("#viewItemDownFilter").addClass("btn-primary");
					$("#viewItemDownFilter").removeClass("btn-secondary");
				} else {
					$("#viewItemDownFilter").removeClass("btn-primary");
					$("#viewItemDownFilter").addClass("btn-secondary");
				}
			}
			this.refreshRelateds(global.item.getCurrent());
		},
		updateCategoryFilter : function(){
			var categories = global.itemCategories;
			if (this._categoryFilter == null){
				this._categoryFilter = new Array();
				this.resetFilter();
			}
			var html = "";
			for (var c = 0; c < global.itemCategories.length; c++){
				html += "<button class='btn btn-sm ";
				if (this._categoryFilter[categories[c].id] == true){
					html += "btn-success";
				} else {
					html += "btn-secondary";
				}
				html += "'onclick='_viewItem._categoryFilter[\""+categories[c].id+"\"]=!_viewItem._categoryFilter[\""+categories[c].id+"\"];_viewItem.updateCategoryFilter();_viewItem.refreshRelateds(global.item.getCurrent());'>";
				html += i18next.t("category."+categories[c].name);
				html += "</button>&nbsp;";
			}
			$("#viewItemFilterCategories").html(html);
		},
		refreshItem : function(item){
			setTimeout(function(){
				if (item == null){
					$("#viewItemId").			val("");
					$("#viewItemName").			val("");
					$("#viewItemCategory").		val("");
					$("#viewItemClass").		val("");
					$("#viewItemUpdateButton").	prop("disabled",true);
					$("#viewItemDeleteButton").	prop("disabled",true);
					$("#viewItemProperties").	html("");
				} else {
					$("#viewItemId").			val(item.id);
					$("#viewItemName").			val(item.name);
					$("#viewItemCategory").		val(i18next.t("category."+item.category.name));
					$("#viewItemClass").		val(item.class.name);
					$("#viewItemUpdateButton").	prop("disabled",true);
					$("#viewItemDeleteButton").	prop("disabled",false);
					var property;
					var html = "";
					for(var i = 0; i < item.properties.length; i++){
						property = item.properties[i];
						html += "<tr><td>"+property.key+"</td><td>"+property.value+"</td></tr>";
					}
					$("#viewItemProperties").html(html);
				}
				this.refreshRelateds(item);
				this.refreshDocumentList(item);
			},10);
		},
		refreshRelateds : function(item){
			$("#viewItemRelatedItems").html("");
			if (item != null){
				if (this._directionDown){
					$.getJSON( "api/item.php?id="+item.id+"&direction=down&related_items", function(result) {
						if (result.code != 0){
							sendMessage("error",i18next.t("message.item_failure_related_items")+" : "+result.message);
						} else {
							var html = "";
							var element;
							var count = 0;
							var elements = result.objects;
							for (var e = 0; e < elements.length; e++){
				    			element = elements[e];
				    			if (_viewItem._categoryFilter[element.category.id] == true){
				    				html += "<tr>";
				    				html += "<td>"+i18next.t("form.item.down")+"</td>";
				    				html += "<td>"+i18next.t("category."+element.category.name)+"</td>";
				    				html += "<td><a href='#' onclick='global.item.open(\""+element.id+"\")'>"+element.name+"</a></td>";
				    				html += '<td>';
				    				html += '<button class="btn btn-danger btn-sm" onClick="global.item.unlink({id : \''+item.id+'\'},{id : \''+element.id+'\'});" title="Unlink \''+element.name+'\' from \''+item.name+'\'">'+i18next.t("form.button.unlink")+'</button>';
				    				html += '</td>';
				    				html += "</tr>";
					    			count++;
					    			if (count > 8){
					    				html += "<tr><td style='text-align:center' colspan='3'>...</td></tr>";
					    				break;
					    			}
				    			}
							}
							$("#viewItemRelatedItems").append(html);
						}
					}).fail(function(jxqr,textStatus,error){
						sendMessage("error",i18next.t("message.item_failure_related_items") + " : "+error);
					});
				}
				if (this._directionUp){
					$.getJSON( "api/item.php?id="+item.id+"&direction=up&related_items", function(result) {
						if (result.code != 0){
							sendMessage("error",i18next.t("message.item_failure_related_items")+" : "+result.message);
						} else {
							var html = "";
							var element;
							var count = 0;
							var elements = result.objects;
							for (var e = 0; e < elements.length; e++){
				    			element = elements[e];
				    			if (_viewItem._categoryFilter[element.category.id] == true){
				    				html += "<tr>";
				    				html += "<td>"+i18next.t("form.item.up")+"</td>";
				    				html += "<td>"+i18next.t("category."+element.category.name)+"</td>";
					    			html += '<td><a href="#" onclick="global.item.open(\''+element.id+'\')">'+element.name+'</a></td>';
					    			html += '<td>';
					    			html += '	<button class="btn btn-danger btn-sm" onClick="global.item.unlink({id : \''+element.id+'\'},{id : \''+item.id+'\'});" title="Unlink \''+element.name+'\' from \"'+item.name+'\'">'+i18next.t("form.button.unlink")+'</button>';
					    			html += '</td>';
					    			html += "</tr>";
					    			count++;
					    			if (count > 8){
					    				html += "<tr><td style='text-align:center' colspan='3'>...</td></tr>";
					    				break;
					    			}
				    			}
							}
							$("#viewItemRelatedItems").append(html);
						}
					}).fail(function(jxqr,textStatus,error){
						sendMessage("error",i18next.t("message.item_failure_related_items") + " : "+error);
					});
				}
			}
		},
		refreshDocumentList : function(item){
			$("#viewItemDocumentsList").html("");
			if (item != null){
				$.getJSON( "api/document.php?itemId="+item.id, function(result) {
					var html = "";
					var document;
					var count = 0;
					for (var d = 0; d < result.documents.length; d++){
						document = result.documents[d];
						html += "<tr><td><a href='#' onclick='global.document.open("+document.id+")'>"+document.name+"</a></td>";
						html += "<td>"+document.type+"</td>";
						html += "<td><button class='btn btn-danger btn-sm' onclick='global.document.unlinkFromItem(\""+document.id+"\",\""+item.id+"\")'>Unlink</button></td>";
						html += "</tr>";
						count++;
		    			if (count > 8){
		    				html += "<tr><td style='text-align:center' colspan='3'>...</td></tr>";
		    				break;
		    			}
					}
					$("#viewItemDocumentsList").html(html);
				}).fail(function(jxqr,textStatus,error){
					sendMessage("error",i18next.t("document_failure_list")+" : "+error);
				});
			}
		},
		updateItem : function(){
			sendMessage("warning",i18next.t("message.not_yet_implemented"));
		}
	};
	$(function(){
		$("#viewItemForm").find('*[data-i18n]').localize();
		_viewItem.updateCategoryFilter();
		_viewItem.refreshItem(global.item.getCurrent());
	});
</script>
</body>
</html>