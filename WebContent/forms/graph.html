<html>
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
</head>
<body>
	<span style="display: none" data-provider="currentItem" onchange="_graph.refreshItem(global.item.getCurrent())"></span>
    <div id="cy" style="width : 100%;height	: 100%;"></div>
    <!-- Load application code at the end to ensure DOM is loaded -->
    <script>
    	var _graph = {
    		cy   : null,
    		init : function(){
    			this.cy = cytoscape({
    	    		  // very commonly used options
    	    		  container				: document.getElementById('cy'),
    	    		  elements				: [],
    	    		  style					: [{
    	    				selector: 'node',
    	    			    style	: {
    	    			        'background-color'	: '#666',
    	    			        'label'				: 'data(label)'
    	    			    }
    	    			},{
    	    				selector: 'node[category="actor"]',
    	    			    style	: {
    	    			        'background-color'	: '#FFAAAA',
    	    			        'label'				: 'data(label)'
    	    			    }
    	    			},{
    	    				selector: 'node[category="solution"]',
    	    			    style	: {
    	    			        'background-color'	: '#AAAAFF',
    	    			        'label'				: 'data(label)'
    	    			    }
    	    			},{
    	    				selector: 'node[category="server"]',
    	    			    style	: {
    	    			        'background-color'	: '#88BBCC',
    	    			        'label'				: 'data(label)'
    	    			    }
    	    			},{
    	    				selector: 'node[category="device"]',
    	    			    style	: {
    	    			        'background-color'	: '#AAFFAA',
    	    			        'label'				: 'data(label)'
    	    			    }
    	    			},{
    	    				selector: 'edge',
    	    			    style	: {
    	    			        'width'				: 3,
    	    			        'line-color'		: '#ccc',
    	    			        'target-arrow-color': '#ccc',
    	    			        'target-arrow-shape': 'triangle'
    	    			    }
    	    			}
    	    		  ],
    	    		  layout				: {
    	    		        name	: 'spread',
    	    		        minDist	: 10
    	    		  },
    	    		  // initial viewport state:
    	    		  zoom					: 1,
    	    		  pan					: { x: 0, y: 0 },
    	    		  // interaction options:
    	    		  minZoom				: 1e-50,
    	    		  maxZoom				: 1e50,
    	    		  zoomingEnabled		: true,
    	    		  userZoomingEnabled	: true,
    	    		  panningEnabled		: true,
    	    		  userPanningEnabled	: true,
    	    		  boxSelectionEnabled	: false,
    	    		  selectionType			: 'single',
    	    		  touchTapThreshold		: 8,
    	    		  desktopTapThreshold	: 4,
    	    		  autolock				: false,
    	    		  autoungrabify			: false,
    	    		  autounselectify		: false,
    	    		  // rendering options:
    	    		  headless				: false,
    	    		  styleEnabled			: true,
    	    		  hideEdgesOnViewport	: false,
    	    		  hideLabelsOnViewport	: false,
    	    		  textureOnViewport		: false,
    	    		  motionBlur			: false,
    	    		  motionBlurOpacity		: 0.2,
    	    		  wheelSensitivity		: 0.5,
    	    		  pixelRatio			: 'auto'
    	    	});
    			this.cy.on('cxttapstart', 'node', function(evt){
    				var node = evt.target;
    				if (!node.data().root && !node.data().loaded) {
    					node.data().loaded = true;
    					_graph.loadRelatedItems(node.id(),false,node.position('x'),node.position('y'));
    				}
    			});
    			this.cy.on('tap', 'node', function(evt){
    				var node = evt.target;
    				global.item.open(node.id());
    			});
    		},
    		loadRelatedItems : function(itemId,layout,x,y){
    			$.getJSON( "api/item.php?id="+itemId+"&direction=both&related_items", function(result) {
					if (result.code != 0){
						sendMessage("error",i18next.t("message.item_failure_related_items")+" : "+result.message);
					} else {
						var nodes = [];
						var elements = result.objects;
						var nodex = -120;
						for (var e = 0; e < elements.length; e++){
			    			element = elements[e];
			    			var node = {
			    				data : { 
			    					id : element.id, 
			    					label : i18next.t("category."+element.category.name) + " - " + element.name,
			    					root : false, 
			    					category : element.category.name,
			    					loaded : false
		    					}
			    			};
			    			if (!layout){
			    				node.position = {
			    			        x: x+nodex,
			    			        y: y-100
			    			    };
			    				nodex += 30;
			    			}
			    			nodes.push(node);
			    			nodes.push({ data : { source : itemId, target : element.id}});
						}
						_graph.cy.add(nodes);
						if (layout){
							_graph.cy.layout( {
	    	  			        name	: 'spread',
	    	  			        animate : true,
	    	  			        fit 	: false,
	    	  			        minDist	: 10
	    	  			  	}).run();
						}
					}
				});
    		},
    		refreshItem : function(item){
    			_graph.cy.remove(_graph.cy.elements("node"));
    			if (item != null){
    				_graph.cy.add({ data : { id : item.id, label : item.name, root : true}});
    				_graph.loadRelatedItems(item.id,true);
    			}
    		}
    	};
		$(function(){
    		_graph.init();  
    		_graph.refreshItem(global.item.getCurrent());
    	});
    </script>
</body>
</html>